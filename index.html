<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<title>Tube Bend Calculator — Correct Tangential Fillets</title>
<style>
body {
  margin:0;
  font-family:system-ui,Segoe UI,sans-serif;
  background:#0d1117; /* nieuwe kleur */
  color:#e5e7eb;
}
.wrapper {
  padding:20px;
  max-width:1400px;
  margin:auto;
}
h2 { margin-top:40px; }
table {
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
}
th, td {
  padding:8px;
  border-bottom:1px solid #333;
}
input, select {
  background:#161b22;
  border:1px solid #333;
  color:white;
  padding:6px;
  border-radius:4px;
}
button {
  background:#238636;
  padding:6px 10px;
  border:none;
  color:white;
  border-radius:4px;
  cursor:pointer;
}
button.del { background:#b62324; }
svg {
  background:#0b0f14;
  width:100%;
  height:550px;
  border:1px solid #222;
  cursor:grab;
}
svg:active { cursor:grabbing; }
.labelbox {
  background:#161b22;
  display:inline-block;
  padding:4px 8px;
  border-radius:6px;
  margin-left:10px;
  border:1px solid #333;
}
</style>
</head>
<body>
<div class="wrapper">

<h1>Tube Bend Calculator — Tangential Fillet Engine</h1>

<button id="addSeg">+ Segment</button>
<button id="clearAll">Clear</button>

<h2>Segmenten (START→P1, P1→P2, ...)</h2>
<table id="segTable">
<thead>
<tr>
  <th>Segment</th>
  <th>Hoek (°)</th>
  <th>Richting</th>
  <th>Lengte (mm)</th>
  <th>Gain (mm)</th>
  <th>Eff. L (mm)</th>
  <th>Del</th>
</tr>
</thead>
<tbody></tbody>
</table>

<h2>CAD-weergave (zoom + pan)</h2>
<svg id="cad" viewBox="-200 -200 800 800"></svg>

<h2>Productie rechte-view</h2>
<div id="prod"></div>

<h2>Instellingen & Totalen</h2>

<div>
Tube OD:
<select id="od">
  <option value="3/8">3/8"</option>
  <option value="1/2" selected>1/2"</option>
</select>
</div>

<div style="margin-top:10px;">
Radius centerline: <span id="radBox" class="labelbox"></span>
</div>
<div style="margin-top:10px;">
Σ rechte stukken: <span id="sumStraight" class="labelbox"></span>
</div>
<div style="margin-top:10px;">
Σ gains: <span id="sumGains" class="labelbox"></span>
</div>
<div style="margin-top:10px;">
Totaal: <span id="sumTotal" class="labelbox"></span>
</div>

</div>

<script>
// ---------------- CONFIG ----------------
const INCH = 25.4;
const CONFIG = {
  od: {
    "3/8": { R_in: 15/16 },   // 0.9375"
    "1/2": { R_in: 1.5 }      // 1.5"
  },
  gains_in: {
    "3/8": { 45: 1/16, 90: 7/16 },
    "1/2": { 45: 1/16, 90: 11/16 }
  }
};

// ---------------- STATE ----------------
let segs = []; // {ang, dir, len}

// ---------------- HELPERS ----------------
function Rmm() {
  const od=document.getElementById("od").value;
  return CONFIG.od[od].R_in * INCH;
}
function gainMM(a){
  const od=document.getElementById("od").value;
  return (CONFIG.gains_in[od][a]||0)*INCH;
}
function dv(a){ return {x:Math.cos(a), y:Math.sin(a)}; }

// ---------------- TABLE ----------------
function updateTable(){
  const tb=document.querySelector("#segTable tbody");
  tb.innerHTML="";
  let sumStraight=0;
  let sumGain=0;

  segs.forEach((s,i)=>{
    const gain=gainMM(s.ang);
    const eff=s.len-gain;
    sumStraight+=s.len;
    sumGain+=gain;

    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>S${i+1}</td>
      <td>
        <select data-i="${i}" data-f="ang">
          <option>0</option>
          <option>45</option>
          <option>90</option>
        </select>
      </td>
      <td>
        <select data-i="${i}" data-f="dir">
          <option value="">—</option>
          <option value="L">L</option>
          <option value="R">R</option>
        </select>
      </td>
      <td><input data-i="${i}" data-f="len" type="number" min="0" step="0.1"></td>
      <td>${gain.toFixed(1)}</td>
      <td>${eff.toFixed(1)}</td>
      <td><button class="del" data-del="${i}">X</button></td>
    `;
    tb.appendChild(tr);

    tr.querySelector('[data-f="ang"]').value=s.ang;
    tr.querySelector('[data-f="dir"]').value=s.dir;
    tr.querySelector('[data-f="len"]').value=s.len;
  });

  document.getElementById("sumStraight").textContent=sumStraight.toFixed(1);
  document.getElementById("sumGains").textContent=sumGain.toFixed(1);
  document.getElementById("sumTotal").textContent=(sumStraight-sumGain).toFixed(1);
  document.getElementById("radBox").textContent=Rmm().toFixed(1)+" mm";

  drawCAD();
  drawProd();
}

// ---------------- CAD TEKENEN (oude correcte logica) ----------------
function drawCAD(){
  const svg=document.getElementById("cad");
  svg.innerHTML="";
  if(segs.length===0) return;

  let path="";
  let started=false;

  let x=0,y=0;
  let dir=0;

  const P=[];
  const R=Rmm();

  for(let i=0;i<segs.length;i++){
    const s=segs[i];

    // ---- BEND FIRST (except S1) ----
    if(i>0 && s.ang>0 && s.dir){
      const a=s.ang*Math.PI/180;
      const sign=s.dir==="L"?+1:-1;
      const v1=dv(dir);

      // trim = R  (oude logica — correct tangentieel voor 90°)
      const trim=R;

      // T1 = hoekpunt - v1*trim
      const T1={x:x - v1.x*trim, y:y - v1.y*trim};

      // center offset afhankelijk van richting
      let cx,cy;
      if(sign>0){ // LEFT
        cx=T1.x - v1.y*R;
        cy=T1.y + v1.x*R;
      } else {    // RIGHT
        cx=T1.x + v1.y*R;
        cy=T1.y - v1.x*R;
      }

      // nieuwe richting
      dir+=sign*a;
      const v2=dv(dir);

      // T2 = T1 + v2*R
      const T2={x:T1.x + v2.x*R, y:T1.y + v2.y*R};

      if(!started){ path=`M ${T1.x} ${T1.y}`; started=true; }
      else path+=` L ${T1.x} ${T1.y}`;

      const sweep=(sign<0)?1:0;
      path+=` A ${R} ${R} 0 0 ${sweep} ${T2.x} ${T2.y}`;

      x=T2.x;
      y=T2.y;
    }

    // ---- Straight ----
    const v=dv(dir);
    const nx=x+v.x*s.len;
    const ny=y+v.y*s.len;

    if(!started){
      path=`M ${nx} ${ny}`;
      started=true;
    } else {
      path+=` L ${nx} ${ny}`;
    }

    x=nx; y=ny;
    P.push({x,y});
  }

  // Path tekenen
  const p=document.createElementNS("http://www.w3.org/2000/svg","path");
  p.setAttribute("d",path);
  p.setAttribute("stroke","#2f81f7");
  p.setAttribute("stroke-width","2");
  p.setAttribute("fill","none");
  svg.appendChild(p);

  // P-labels
  P.forEach((pt,i)=>{
    const c=document.createElementNS("http://www.w3.org/2000/svg","circle");
    c.setAttribute("cx",pt.x);
    c.setAttribute("cy",pt.y);
    c.setAttribute("r",3);
    c.setAttribute("fill","#0d1117");
    c.setAttribute("stroke","#2f81f7");
    svg.appendChild(c);

    const t=document.createElementNS("http://www.w3.org/2000/svg","text");
    t.textContent=`P${i+1}`;
    t.setAttribute("x",pt.x+6);
    t.setAttribute("y",pt.y-6);
    t.setAttribute("fill","#e5e7eb");
    t.setAttribute("font-size","12");
    svg.appendChild(t);
  });
}

// ---------------- PRODUCTIEVIEW ----------------
function drawProd(){
  let html="<h3>Rechte productie-lengtes</h3>";
  segs.forEach((s,i)=>{
    const gain=gainMM(s.ang);
    html+=`S${i+1}: ${(s.len-gain).toFixed(1)} mm<br>`;
  });
  document.getElementById("prod").innerHTML=html;
}

// ---------------- EVENTS ----------------
document.getElementById("addSeg").onclick=function(){
  segs.push({ang:0, dir:"", len:100});
  updateTable();
};
document.getElementById("clearAll").onclick=function(){
  segs=[]; updateTable();
};
document.getElementById("od").onchange=updateTable;

document.querySelector("#segTable").addEventListener("input",e=>{
  const i=e.target.dataset.i;
  const f=e.target.dataset.f;
  if(i!==undefined){
    if(f==="ang") segs[i].ang=Number(e.target.value);
    if(f==="dir") segs[i].dir=e.target.value;
    if(f==="len") segs[i].len=Number(e.target.value);
    updateTable();
  }
});
document.querySelector("#segTable").addEventListener("click",e=>{
  if(e.target.dataset.del!==undefined){
    segs.splice(Number(e.target.dataset.del),1);
    updateTable();
  }
});

// PAN + ZOOM
(function(){
  const svg=document.getElementById("cad");
  let down=false, sx,sy;
  let vx=-200, vy=-200, vw=800;
  svg.addEventListener("mousedown",e=>{down=true; sx=e.clientX; sy=e.clientY;});
  svg.addEventListener("mousemove",e=>{
    if(!down) return;
    const dx=e.clientX-sx;
    const dy=e.clientY-sy;
    vx -= dx*(vw/800);
    vy -= dy*(vw/800);
    svg.setAttribute("viewBox",`${vx} ${vy} ${vw} ${vw}`);
    sx=e.clientX; sy=e.clientY;
  });
  svg.addEventListener("mouseup",()=>down=false);
  svg.addEventListener("mouseleave",()=>down=false);
  svg.addEventListener("wheel",e=>{
    e.preventDefault();
    const f=1+(e.deltaY>0?0.1:-0.1);
    vw*=f;
    svg.setAttribute("viewBox",`${vx} ${vy} ${vw} ${vw}`);
  });
})();

// INIT
updateTable();
</script>
</body>
</html>
