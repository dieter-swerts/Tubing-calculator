<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8">
<title>Tube Bend Length Calculator — CAD-style</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
    body {
        margin:0;
        background:#0f172a;
        color:#e5e7eb;
        font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    }
    header { padding:16px 22px; border-bottom:1px solid #1f2937; }
    h1 { margin:0; font-size:18px; }
    main { padding:16px; display:flex; flex-direction:column; gap:18px; }

    table { width:100%; border-collapse:collapse; background:#111827; border-radius:8px; overflow:hidden; }
    th,td { padding:8px; border-bottom:1px solid #1e293b; font-size:13px; }
    th { background:#1e293b; font-weight:600; }
    td input, td select { width:100%; padding:5px; background:#0b1020; color:#e5e7eb; border:1px solid #334155; border-radius:6px; }

    button { padding:7px 12px; border-radius:6px; border:none; cursor:pointer; font-weight:600; }
    .add { background:#38bdf8; color:#042c3c; }
    .sec { background:#1e293b; color:#e5e7eb; border:1px solid #334155; }

    .chip { background:#0b1020; border:1px solid #334155; padding:4px 8px; border-radius:999px; }
    svg { width:100%; height:500px; background:#0b1020; border-radius:10px; }
</style>
</head>
<body>

<header>
  <h1>Tube Bend Length Calculator — CAD-style</h1>
</header>

<main>

<!-- SEGMENT TABEL -->
<section>
<table id="segTable">
<thead>
<tr>
  <th>#</th>
  <th>Lengte (mm)</th>
  <th>Hoek (°)</th>
  <th>Richting</th>
  <th>Gain (mm)</th>
  <th></th>
</tr>
</thead>
<tbody></tbody>
</table>
<div style="margin-top:8px;">
  <button class="add" id="addSeg">+ Segment</button>
  <button class="sec" id="csvBtn">CSV</button>
  <button class="sec" id="clearSeg">Clear</button>
</div>
</section>

<!-- INSTELLINGEN + RESULTATEN -->
<section>
    <label>Tube OD:</label>
    <select id="od">
        <option value="1/2">1/2"</option>
        <option value="3/8">3/8"</option>
    </select>

    <p>Radius: <span id="radiusMM" class="chip"></span></p>

    <p>Σ rechte stukken: <span id="sumStraight" class="chip"></span></p>
    <p>Σ gains: <span id="sumGain" class="chip"></span></p>
    <p><b>TOTAAL:</b> <span id="totalLen" class="chip"></span></p>
</section>

<!-- SVG -->
<section>
<svg id="svg" viewBox="0 0 900 500">
    <g id="draw" transform="translate(40,250)"></g>
</svg>
</section>

</main>

<script>
/* CONFIG */
const INCH=25.4;
const ANG=[0,22.5,30,45,50,55,60,65,70,75,80,85,90];

const RAD={
 "1/2":1.5*INCH,
 "3/8":15/16*INCH
};

const GAIN={
 "1/2":{0:0,22.5:0,30:1/16,45:1/16,50:1/8,55:1/8,60:3/16,65:1/4,70:5/16,75:3/8,80:7/16,85:9/16,90:11/16},
 "3/8":{0:0,22.5:0,30:0,45:1/16,50:1/16,55:1/8,60:1/8,65:1/8,70:3/16,75:1/4,80:5/16,85:3/8,90:7/16}
};

let segs=[];
const tbody=document.querySelector("#segTable tbody");

function gainMM(od,ang){return (GAIN[od][ang]||0)*INCH;}
function round1(x){return Math.round(x*10)/10;}
function od(){return document.getElementById("od").value;}
function radius(){return RAD[od()]||0;}

function refreshRows(){
 let i=1;
 [...tbody.children].forEach(tr=>tr.children[0].textContent=i++);
}

/* ADD SEGMENT ROW */
function addSeg(init={len:100,ang:90,dir:"R"}){
 const tr=document.createElement("tr");

 const tdIdx=document.createElement("td"); tdIdx.textContent=segs.length+1;

 const tdLen=document.createElement("td");
 const il=document.createElement("input");
 il.type="number"; il.value=init.len; il.step="0.1"; tdLen.appendChild(il);

 const tdAng=document.createElement("td");
 const sa=document.createElement("select");
 ANG.forEach(a=>{const o=document.createElement("option");o.value=a;o.textContent=a;sa.appendChild(o);});
 sa.value=init.ang; tdAng.appendChild(sa);

 const tdDir=document.createElement("td");
 const sd=document.createElement("select");
 [["","—"],["L","L"],["R","R"]].forEach(v=>{
   const o=document.createElement("option");o.value=v[0];o.textContent=v[1];sd.appendChild(o);
 });
 sd.value=init.dir||""; tdDir.appendChild(sd);

 const tdGain=document.createElement("td");

 const tdDel=document.createElement("td");
 const b=document.createElement("button"); b.textContent="✖"; b.className="sec"; tdDel.appendChild(b);

 tr.append(tdIdx,tdLen,tdAng,tdDir,tdGain,tdDel);
 tbody.appendChild(tr);

 const S={len:init.len,ang:init.ang,dir:init.dir,g:0};
 segs.push(S);

 function recalc(){
   S.len=Number(il.value);
   S.ang=Number(sa.value);
   S.dir=sd.value||null;
   S.g=gainMM(od(),S.ang);
   tdGain.textContent=round1(S.g);
   calc();
 }
 il.oninput=recalc; sa.onchange=recalc; sd.onchange=recalc;

 b.onclick=()=>{
   const i=[...tbody.children].indexOf(tr);
   segs.splice(i,1);
   tr.remove();
   refreshRows();
   calc();
 };

 recalc();
}

/* CALCULATION */
function calc(){
 const sumS=segs.reduce((a,s)=>a+s.len,0);
 const sumG=segs.reduce((a,s)=>a+s.g,0);
 const tot=sumS-sumG;

 document.getElementById("sumStraight").textContent=round1(sumS);
 document.getElementById("sumGain").textContent=round1(sumG);
 document.getElementById("totalLen").textContent=round1(tot);
 document.getElementById("radiusMM").textContent=round1(radius())+" mm";

 drawSVG();
}

/* SVG DRAWING — CAD FILLET */
function drawSVG(){
 const g=document.getElementById("draw");
 g.innerHTML="";

 if(segs.length===0)return;

 const Rmm=radius();
 const scale=0.6;

 const R=Rmm*scale;

 let x=0,y=0;
 let dir=0; // rad

 const pts=[];

 function dirVec(a){return {x:Math.cos(a),y:Math.sin(a)};}

 let path=`M ${x} ${y}`;

 segs.forEach((s,i)=>{
   const v=dirVec(dir);
   const L=s.len*scale;
   const vx=x+v.x*L;
   const vy=y+v.y*L;
   pts.push({x:vx,y:vy});

   if(!s.ang||!s.dir){
     path+=` L ${vx} ${vy}`;
     x=vx; y=vy;
   } else {
     const alpha=s.ang*Math.PI/180;
     const sign=s.dir==="L"?+1:-1;

     const t=R*Math.tan(alpha/2);
     const t1x=x+v.x*(L-t);
     const t1y=y+v.y*(L-t);

     path+=` L ${t1x} ${t1y}`;

     const n = sign>0 ? {x:-v.y,y:v.x} : {x:v.y,y:-v.x};

     const cx=t1x+n.x*R;
     const cy=t1y+n.y*R;

     const v1={x:t1x-cx, y:t1y-cy};
     const cs=Math.cos(sign*alpha), sn=Math.sin(sign*alpha);
     const v2={x:v1.x*cs - v1.y*sn, y:v1.x*sn + v1.y*cs};
     const t2x=cx+v2.x, t2y=cy+v2.y;

     const sweep=sign>0?1:0;
     path+=` A ${R} ${R} 0 0 ${sweep} ${t2x} ${t2y}`;

     x=t2x; y=t2y;
     dir+=sign*alpha;
   }
 });

 const p=document.createElementNS("http://www.w3.org/2000/svg","path");
 p.setAttribute("d",path);
 p.setAttribute("stroke","#38bdf8");
 p.setAttribute("stroke-width","2");
 p.setAttribute("fill","none");
 g.appendChild(p);

 pts.forEach((p,i)=>{
   const c=document.createElementNS("http://www.w3.org/2000/svg","circle");
   c.setAttribute("cx",p.x); c.setAttribute("cy",p.y);
   c.setAttribute("r",3); c.setAttribute("fill","#0f172a");
   c.setAttribute("stroke","#38bdf8"); g.appendChild(c);

   const t=document.createElementNS("http://www.w3.org/2000/svg","text");
   t.setAttribute("x",p.x+6); t.setAttribute("y",p.y-6);
   t.setAttribute("fill","#e5e7eb");
   t.setAttribute("font-size","12");
   t.textContent="P"+(i+1);
   g.appendChild(t);
 });
}

/* CSV */
document.getElementById("csvBtn").onclick=()=>{
 let rows=[["#","Length","Angle","Dir","Gain(mm)"]];
 segs.forEach((s,i)=>rows.push([i+1,s.len,s.ang,s.dir||"",round1(s.g)]));
 const csv=rows.map(r=>r.join(",")).join("\n");
 const blob=new Blob([csv],{type:"text/csv"});
 const url=URL.createObjectURL(blob);
 const a=document.createElement("a");
 a.href=url; a.download="tube.csv"; a.click();
 URL.revokeObjectURL(url);
};

/* INIT */
document.getElementById("clearSeg").onclick=()=>{segs=[];tbody.innerHTML="";calc();}
document.getElementById("od").onchange=()=>calc();

addSeg({len:165,ang:90,dir:"R"});
addSeg({len:100,ang:90,dir:"L"});
addSeg({len:185,ang:0,dir:null});
calc();
</script>

</body>
</html>
