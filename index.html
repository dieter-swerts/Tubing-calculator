<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<title>Tube Bend Calculator — CAD-grade Fillets</title>
<style>
    body {
        margin:0;
        font-family:system-ui,Segoe UI,sans-serif;
        background:#0d1117;
        color:#e5e7eb;
    }
    .wrapper {
        max-width:1400px;
        margin:auto;
        padding:20px;
    }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { padding:8px; border-bottom:1px solid #333; }
    select, input {
        background:#161b22; border:1px solid #333;
        color:white; padding:6px; border-radius:4px;
    }
    button {
        background:#238636; border:none; padding:6px 10px;
        border-radius:4px; color:white; cursor:pointer;
    }
    button.del { background:#b62324; }
    svg {
        width:100%; height:550px; background:#0b0f14;
        border:1px solid #222; cursor:grab;
    }
    svg:active { cursor:grabbing; }
    .labelbox {
        background:#161b22; border:1px solid #333;
        padding:4px 8px; border-radius:6px;
    }
</style>
</head>
<body>
<div class="wrapper">

<h1>Tube Bend Calculator — CAD-grade Fillet Engine</h1>

<button id="addSeg">+ Segment</button>
<button id="clearAll">Clear</button>

<h2>Segmenten (START → P1 → P2 → …)</h2>

<table id="segTable">
<thead>
<tr>
  <th>Segment</th>
  <th>Hoek (°)</th>
  <th>Richting</th>
  <th>Lengte (mm)</th>
  <th>Gain</th>
  <th>Eff.</th>
  <th></th>
</tr>
</thead>
<tbody></tbody>
</table>

<h2>CAD-weergave (zoom + pan)</h2>
<svg id="cad" viewBox="-200 -200 800 800"></svg>

<h2>Productie rechte weergave</h2>
<div id="prod"></div>

<h2>Instellingen & Totalen</h2>

Tube OD:
<select id="od">
  <option value="3/8">3/8"</option>
  <option value="1/2" selected>1/2"</option>
</select>

<div style="margin-top:10px;">Radius: <span id="radBox" class="labelbox"></span></div>
<div style="margin-top:10px;">Σ rechte: <span id="sumStraight" class="labelbox"></span></div>
<div style="margin-top:10px;">Σ gains: <span id="sumGains" class="labelbox"></span></div>
<div style="margin-top:10px;">Totaal: <span id="sumTotal" class="labelbox"></span></div>

</div>

<script>
// ===========================
// CONFIG
// ===========================
const INCH = 25.4;
const CONFIG = {
  od: {
    "3/8": { R_in: 0.9375 },
    "1/2": { R_in: 1.5 }
  },
  gains_in: {
    "3/8": { 45: 1/16, 90: 7/16 },
    "1/2": { 45: 1/16, 90: 11/16 }
  }
};

// ===========================
// STATE
// ===========================
let segs = [];  // {ang, dir, len}

// ===========================
// HELPERS
// ===========================
const rad = d => d*Math.PI/180;
const norm = v => { let L=Math.hypot(v.x,v.y); return {x:v.x/L, y:v.y/L}; };
const perp = v => ({ x:-v.y, y:v.x });
function Rmm(){ return CONFIG.od[document.getElementById("od").value].R_in * INCH; }
function gainMM(a){
  const od=document.getElementById("od").value;
  return (CONFIG.gains_in[od][a]||0)*INCH;
}
function intersect(p,r,q,s){
  const A=r.x, B=-s.x;
  const C=r.y, D=-s.y;
  const E=q.x-p.x, F=q.y-p.y;
  const det=A*D-B*C;
  if(Math.abs(det)<1e-6) return null;
  const t=(E*D-B*F)/det;
  return { x:p.x+t*r.x, y:p.y+t*r.y };
}

// ===========================
// UPDATE TABLE
// ===========================
function updateTable(){
  const tb=document.querySelector("#segTable tbody");
  tb.innerHTML="";
  let sumStraight=0, sumGain=0;

  segs.forEach((s,i)=>{
    let g=gainMM(s.ang);
    let eff=s.len-g;

    sumStraight+=s.len;
    sumGain+=g;

    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>S${i+1}</td>
      <td>
        <select data-i="${i}" data-f="ang">
          ${[0,22.5,30,45,55,60,75,90].map(a=>`<option>${a}</option>`).join("")}
        </select>
      </td>
      <td>
        <select data-i="${i}" data-f="dir">
          <option value="">—</option>
          <option value="L">L</option>
          <option value="R">R</option>
        </select>
      </td>
      <td><input data-i="${i}" data-f="len" type="number" step="0.1"></td>
      <td>${g.toFixed(1)}</td>
      <td>${eff.toFixed(1)}</td>
      <td><button class="del" data-del="${i}">X</button></td>
    `;
    tb.appendChild(tr);

    tr.querySelector('[data-f="ang"]').value=s.ang;
    tr.querySelector('[data-f="dir"]').value=s.dir;
    tr.querySelector('[data-f="len"]').value=s.len;
  });

  document.getElementById("sumStraight").textContent=sumStraight.toFixed(1);
  document.getElementById("sumGains").textContent=sumGain.toFixed(1);
  document.getElementById("sumTotal").textContent=(sumStraight-sumGain).toFixed(1);
  document.getElementById("radBox").textContent=Rmm().toFixed(1)+" mm";

  drawCAD();
  drawProd();
}

// ===========================
// CAD ENGINE — polyline → fillets
// ===========================
function drawCAD(){
  const svg=document.getElementById("cad");
  svg.innerHTML="";
  if(segs.length===0) return;

  // ---- 1) POLYLINE ----
  const pts=[{x:0,y:0}];
  let ang=0;
  let x=0,y=0;

  for(let i=0;i<segs.length;i++){
    const s=segs[i];

    if(i>0 && s.ang>0 && s.dir){
      ang += (s.dir==="L"?+1:-1)*rad(s.ang);
    }

    x += Math.cos(ang)*s.len;
    y += Math.sin(ang)*s.len;
    pts.push({x,y});
  }

  // ---- 2) FILLET REPLACE ----
  const R = Rmm();
  let path = `M ${pts[0].x} ${pts[0].y}`;

  for(let i=1;i<pts.length-1;i++){
    const P0=pts[i-1], P1=pts[i], P2=pts[i+1];
    const v1=norm({x:P1.x-P0.x,y:P1.y-P0.y});
    const v2=norm({x:P2.x-P1.x,y:P2.y-P1.y});
    const dot=v1.x*v2.x+v1.y*v2.y;
    const angBetween=Math.acos(dot);

    if(angBetween<1e-6){ path+=` L ${P1.x} ${P1.y}`; continue; }

    const trim = R / Math.tan(angBetween/2);

    const T1={ x:P1.x - v1.x*trim, y:P1.y - v1.y*trim };
    const T2={ x:P1.x + v2.x*trim, y:P1.y + v2.y*trim };

    const cross = v1.x*v2.y - v1.y*v2.x;
    const side = (cross>=0?+1:-1);

    const n1=norm(perp(v1));
    const n2=norm(perp(v2));

    const O1={ x:T1.x + n1.x*R*side, y:T1.y + n1.y*R*side };
    const O2={ x:T2.x + n2.x*R*side, y:T2.y + n2.y*R*side };

    const C = intersect(O1, v1, O2, v2);
    if(!C){
      path+=` L ${P1.x} ${P1.y}`;
      continue;
    }

    path+=` L ${T1.x} ${T1.y}`;
    const sweep=(side>0?1:0);
    path+=` A ${R} ${R} 0 0 ${sweep} ${T2.x} ${T2.y}`;
  }

  const last=pts[pts.length-1];
  path+=` L ${last.x} ${last.y}`;

  // DRAW PATH
  const p=document.createElementNS("http://www.w3.org/2000/svg","path");
  p.setAttribute("d",path);
  p.setAttribute("stroke","#2f81f7");
  p.setAttribute("stroke-width","2");
  p.setAttribute("fill","none");
  svg.appendChild(p);

  // LABELS
  pts.slice(1).forEach((pt,i)=>{
    const c=document.createElementNS("http://www.w3.org/2000/svg","circle");
    c.setAttribute("cx",pt
