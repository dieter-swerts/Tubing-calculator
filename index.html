<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<title>Tube Bend CAD — Perfect Fillets</title>
<style>
body{
    margin:0;
    background:#111621; /* NIEUWE donkerblauw tint zodat je verschil ziet */
    color:#e6e8eb;
    font-family:system-ui,Segoe UI,sans-serif;
    padding:20px;
}
h1{ margin-bottom:20px; }
table{
    border-collapse:collapse;
    margin-bottom:20px;
}
th,td{
    padding:6px 10px;
    border-bottom:1px solid #333;
}
input, select{
    background:#1a2030;
    border:1px solid #444;
    color:white;
    padding:4px 6px;
    border-radius:4px;
}
button{
    background:#1e7ef0;
    border:none;
    color:white;
    padding:6px 10px;
    border-radius:4px;
    cursor:pointer;
}
button:hover{ background:#3c92ff; }

svg{
    width:100%;
    height:600px;
    background:#0d131d; /* NIEUWE kleur */
    border:1px solid #333;
}
</style>
</head>
<body>

<h1>CAD Tube Bend Engine — Tangentiële Fillets</h1>

<button id="addSeg">+ Segment</button>
<table id="segTable">
<thead>
<tr>
  <th>Hoek (°)</th>
  <th>Richting</th>
  <th>Lengte (mm)</th>
</tr>
</thead>
<tbody></tbody>
</table>

<svg id="canvas" viewBox="-250 -250 800 800"></svg>

<script>
// =========================================================
// STATE
// =========================================================
let segs = [];           // {angle, dir, len}
let R = 38.1;            // centerline radius – constant voor test

// =========================================================
// TABLE UI
// =========================================================
function rebuildTable(){
    const tb=document.querySelector("#segTable tbody");
    tb.innerHTML="";

    segs.forEach((s,i)=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`
            <td>
              <select data-i="${i}" data-f="angle">
                <option>0</option>
                <option>22.5</option>
                <option>30</option>
                <option>45</option>
                <option>55</option>
                <option>60</option>
                <option>70</option>
                <option>75</option>
                <option>80</option>
                <option>85</option>
                <option>90</option>
              </select>
            </td>
            <td>
              <select data-i="${i}" data-f="dir">
                <option value="L">L</option>
                <option value="R">R</option>
              </select>
            </td>
            <td>
              <input type="number" min="1" step="1" data-i="${i}" data-f="len" value="${s.len}">
            </td>
        `;
        tb.appendChild(tr);
        tr.querySelector('[data-f="angle"]').value=s.angle;
        tr.querySelector('[data-f="dir"]').value=s.dir;
    });
}

document.getElementById("addSeg").onclick=()=>{
    segs.push({angle:0, dir:"L", len:120});
    rebuildTable();
    draw();
};

// Live editing
document.querySelector("#segTable").addEventListener("input",e=>{
    const i=e.target.dataset.i;
    const f=e.target.dataset.f;
    if(f==="angle") segs[i].angle=Number(e.target.value);
    if(f==="dir")   segs[i].dir=e.target.value;
    if(f==="len")   segs[i].len=Number(e.target.value);
    draw();
});

// =========================================================
// VECTOR MATH
// =========================================================
function v(x,y){return {x,y};}
function add(a,b){return v(a.x+b.x,a.y+b.y);}
function sub(a,b){return v(a.x-b.x,a.y-b.y);}
function mul(a,s){return v(a.x*s,a.y*s);}
function len(a){return Math.hypot(a.x,a.y);}
function norm(a){const L=len(a); return v(a.x/L,a.y/L);}

// direction from angle (radians)
function dirVec(angleRad){
    return v(Math.cos(angleRad), Math.sin(angleRad));
}

// =========================================================
// MAIN DRAW ROUTINE
// =========================================================
function draw(){
    const svg=document.getElementById("canvas");
    svg.innerHTML="";

    if(segs.length===0) return;

    // --------------------------------------
    // STEP 1: Build raw polyline points
    // --------------------------------------
    let pts=[v(0,0)];
    let ang=0;  // current direction in radians

    segs.forEach(s=>{
        // rotate direction first
        const sign = (s.dir==="L" ? +1 : -1);
        ang += sign * (s.angle*Math.PI/180);

        const d = dirVec(ang);
        const newP = add( pts[pts.length-1], mul(d,s.len) );
        pts.push(newP);
    });

    // --------------------------------------
    // STEP 2: Build path with fillets
    // --------------------------------------
    let path="";
    const L=pts.length;

    for(let i=0;i<L;i++){
        if(i===0){
            path+=`M ${pts[i].x} ${pts[i].y}`;
            continue;
        }

        // If no fillet possible (endpoints)
        if(i===L-1){
            path+=` L ${pts[i].x} ${pts[i].y}`;
            continue;
        }

        // Compute fillet at pts[i]
        const p0=pts[i-1];
        const p1=pts[i];
        const p2=pts[i+1];

        const v1 = norm( sub(p0,p1) ); // backwards
        const v2 = norm( sub(p2,p1) ); // forward

        const dot = v1.x*v2.x + v1.y*v2.y;
        let angle = Math.acos(dot);          // turning angle
        if(angle<0.001){                     // straight line
            path+=` L ${p1.x} ${p1.y}`;
            continue;
        }

        // Fillet trim distance
        const trim = R / Math.tan(angle/2);

        // Trim endpoints
        const T1 = add(p1, mul(v1, trim));
        const T2 = add(p1, mul(v2, trim));

        // Center of fillet arc
        const bis = norm( add(v1,v2) );
        const dist = R / Math.sin(angle/2);
        const C = add( p1, mul(bis, dist) );

        // Determine sweep flag
        const cross = v1.x*v2.y - v1.y*v2.x;
        const sweep = (cross<0)?1:0;

        // Add line to T1
        path+=` L ${T1.x} ${T1.y}`;

        // Add arc T1→T2
        path+=` A ${R} ${R} 0 0 ${sweep} ${T2.x} ${T2.y}`;
    }

    // --------------------------------------
    // PATH DRAW
    // --------------------------------------
    const p=document.createElementNS("http://www.w3.org/2000/svg","path");
    p.setAttribute("d",path);
    p.setAttribute("fill","none");
    p.setAttribute("stroke","#3fa7ff");
    p.setAttribute("stroke-width","2.5");
    svg.appendChild(p);

    // Point markers
    pts.forEach((pt,i)=>{
        const c=document.createElementNS("http://www.w3.org/2000/svg","circle");
        c.setAttribute("cx",pt.x);
        c.setAttribute("cy",pt.y);
        c.setAttribute("r",3);
        c.setAttribute("fill","#0d131d");
        c.setAttribute("stroke","#3fa7ff");
        svg.appendChild(c);

        const t=document.createElementNS("http://www.w3.org/2000/svg","text");
        t.textContent="P"+i;
        t.setAttribute("x",pt.x+5);
        t.setAttribute("y",pt.y-5);
        t.setAttribute("fill","#e6e8eb");
        t.setAttribute("font-size","12");
        svg.appendChild(t);
    });
}

// Init
rebuildTable();
draw();
</script>

</body>
</html>
